---
import path from "node:path";
import Giscus from "@components/misc/Giscus.astro";
import ImageWrapper from "@components/misc/ImageWrapper.astro";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import PostMetadata from "@components/PostMeta.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import {
  resolveContentValidityStage,
  shouldShowContentValidityBanner,
} from "@utils/content-validity";
import { formatDateToYYYYMMDD } from "@utils/date-utils";
import { getDir, getPostUrlBySlug } from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import {
  contentValidityConfig,
  giscusConfig,
  licenseConfig,
  profileConfig,
  siteConfig,
} from "@/config";
import type { ContentValidityStage } from "@/types/config";

export async function getStaticPaths() {
  const blogEntries = await getSortedPosts();
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const renderedEntry = await entry.render();
const { Content, headings, remarkPluginFrontmatter } = renderedEntry;

type BlogPostingLd = {
  "@context": "https://schema.org";
  "@type": "BlogPosting";
  headline: string;
  description: string;
  keywords: string[];
  author: {
    "@type": "Person";
    name: string;
    url: string | URL;
  };
  datePublished: string;
  inLanguage: string;
  image?: string;
};

type ContentValidityCopy = {
  label: string;
  description: string;
};

type ValidityIndicatorPayload = {
  published: string;
  thresholds: typeof contentValidityConfig.thresholds;
  texts: Record<ContentValidityStage, ContentValidityCopy>;
  styles: typeof contentValidityConfig.banner;
  mixing: typeof stageMixing;
};

type ValidityIndicatorData = {
  texts: Record<ContentValidityStage, ContentValidityCopy>;
  stage: ContentValidityStage;
  payload: ValidityIndicatorPayload;
  style: string;
};

const stageOrder: ContentValidityStage[] = ["fresh", "caution", "expired"];
const stageMixing: Record<
  ContentValidityStage,
  { theme: number; accent: number }
> = {
  fresh: { theme: 70, accent: 30 },
  caution: { theme: 50, accent: 50 },
  expired: { theme: 30, accent: 70 },
};

const composeBannerVars = (stage: ContentValidityStage): string => {
  const accent = contentValidityConfig.banner[stage].accent;
  const { theme, accent: accentRatio } = stageMixing[stage];
  const borderTheme = Math.min(theme + 15, 100);
  const borderAccent = Math.max(accentRatio - 15, 0);
  return [
    `--validity-accent-${stage}:${accent}`,
    `--validity-bg-${stage}:color-mix(in oklab,var(--primary) ${theme}%, ${accent} ${accentRatio}%)`,
    `--validity-border-${stage}:color-mix(in oklab,var(--primary) ${borderTheme}%, ${accent} ${borderAccent}%)`,
    `--validity-text-${stage}:color-mix(in oklab, ${accent} 45%, black)`,
    `--validity-muted-${stage}:color-mix(in oklab, ${accent} 30%, black)`,
    `--validity-icon-${stage}:color-mix(in oklab, ${accent} 80%, white)`,
  ].join("; ");
};

const validityIndicator: ValidityIndicatorData | null = (() => {
  if (entry.data.validityCheck === false) {
    return null;
  }
  if (
    !shouldShowContentValidityBanner(
      entry.data.published,
      contentValidityConfig
    )
  ) {
    return null;
  }
  const { freshMonths, cautionMonths } = contentValidityConfig.thresholds;
  const texts: Record<ContentValidityStage, ContentValidityCopy> = {
    fresh: {
      label: i18n(I18nKey.contentValidityFreshLabel),
      description: i18n(I18nKey.contentValidityFreshDescription, {
        freshMonths,
      }),
    },
    caution: {
      label: i18n(I18nKey.contentValidityCautionLabel),
      description: i18n(I18nKey.contentValidityCautionDescription, {
        freshMonths,
      }),
    },
    expired: {
      label: i18n(I18nKey.contentValidityExpiredLabel),
      description: i18n(I18nKey.contentValidityExpiredDescription, {
        cautionMonths,
      }),
    },
  };
  const stage = resolveContentValidityStage(
    entry.data.published,
    new Date(),
    contentValidityConfig
  );
  const payload: ValidityIndicatorPayload = {
    published: entry.data.published.toISOString(),
    thresholds: contentValidityConfig.thresholds,
    texts,
    styles: contentValidityConfig.banner,
    mixing: stageMixing,
  };
  const style = `${stageOrder.map((s) => composeBannerVars(s)).join("; ")};`;
  return { texts, stage, payload, style };
})();

const jsonLd: BlogPostingLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: entry.data.title,
  description: entry.data.description || entry.data.title,
  keywords: entry.data.tags,
  author: {
    "@type": "Person",
    name: profileConfig.name,
    url: Astro.site ?? "",
  },
  datePublished: formatDateToYYYYMMDD(entry.data.published),
  inLanguage: entry.data.lang
    ? entry.data.lang.replace("_", "-")
    : siteConfig.lang.replace("_", "-"),
};
if (entry.data.image) {
  const img = entry.data.image.startsWith("http")
    ? entry.data.image
    : new URL(entry.data.image, Astro.site).toString();
  jsonLd.image = img;
}
---

<MainGridLayout
  banner={entry.data.image}
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.lang}
  setOGTypeArticle={true}
  headings={headings}
>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(jsonLd)}
  />
  <div
    class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4"
  >
    <div
      id="post-container"
      class:list={[
        "card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ",
        {},
      ]}
    >
      <!-- word count and reading time -->
      <div
        class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
      >
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:notes-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.words}
            {" " + i18n(I18nKey.wordsCount)}
          </div>
        </div>
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:schedule-outline-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.minutes}
            {
              " " +
                i18n(
                  remarkPluginFrontmatter.minutes === 1
                    ? I18nKey.minuteCount
                    : I18nKey.minutesCount
                )
            }
          </div>
        </div>
      </div>

      <!-- title (use semantic h1 for accessibility and Swup announcements) -->
      <div class="relative onload-animation">
        <h1
          data-pagefind-body
          data-pagefind-weight="10"
          data-pagefind-meta="title"
          class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-[0.75rem] before:left-[-1.125rem]"
        >
          {entry.data.title}
        </h1>
      </div>

      <!-- metadata -->
      <div class="onload-animation">
        <PostMetadata
          class="mb-5"
          published={entry.data.published}
          updated={entry.data.updated}
          tags={entry.data.tags}
          category={entry.data.category}
        />
        {
          validityIndicator && (
            <>
              <div
                id="content-validity-indicator"
                class="content-validity-indicator"
                data-stage={validityIndicator.stage}
                role="status"
                aria-live="polite"
                style={validityIndicator.style}
              >
                <div
                  class="content-validity-indicator__icon"
                  aria-hidden="true"
                >
                  <Icon
                    data-validity="icon"
                    name={
                      contentValidityConfig.banner[validityIndicator.stage].icon
                    }
                    class="content-validity-indicator__icon-symbol"
                  />
                </div>
                <div class="content-validity-indicator__body">
                  <p
                    data-validity="label"
                    class="content-validity-indicator__label"
                  >
                    {validityIndicator.texts[validityIndicator.stage].label}
                  </p>
                  <p
                    data-validity="description"
                    class="content-validity-indicator__description"
                  >
                    {
                      validityIndicator.texts[validityIndicator.stage]
                        .description
                    }
                  </p>
                </div>
              </div>
              <script
                id="content-validity-indicator-config"
                type="application/json"
                is:inline
                set:html={JSON.stringify(validityIndicator.payload)}
              />
              <script is:inline>
                {`(() => {
  const indicator = document.getElementById("content-validity-indicator");
  const payloadElement = document.getElementById("content-validity-indicator-config");
  if (!indicator || !payloadElement) {
    return;
  }
  let payload;
  try {
    payload = JSON.parse(payloadElement.textContent || "{}");
  } catch (err) {
    return;
  }
  const published = new Date(payload.published);
  if (Number.isNaN(published.getTime())) {
    return;
  }
  const now = new Date();
  const daysPerMonth = payload.daysPerMonth || 30;
  const months = (now.getTime() - published.getTime()) / (daysPerMonth * 24 * 60 * 60 * 1000);
  let stage = "fresh";
  if (months > payload.thresholds.cautionMonths) {
    stage = "expired";
  } else if (months > payload.thresholds.freshMonths) {
    stage = "caution";
  }
  indicator.dataset.stage = stage;
  const texts = payload.texts?.[stage];
  const styles = payload.styles?.[stage];
  const labelEl = indicator.querySelector('[data-validity="label"]');
  const descriptionEl = indicator.querySelector('[data-validity="description"]');
  const iconEl = indicator.querySelector('[data-validity="icon"]');
  if (texts?.label && labelEl) {
    labelEl.textContent = texts.label;
  }
  if (texts?.description && descriptionEl) {
    descriptionEl.textContent = texts.description;
  }
    if (window.AstroIcon && typeof window.AstroIcon.render === "function") {
      iconEl.innerHTML = window.AstroIcon.render({ name: styles.icon });
    } else {
      // Fallback: clear the icon if AstroIcon runtime is not available
      iconEl.innerHTML = "";
    }
    iconEl.setAttribute('name', styles.icon);
  }
  const stages = ["fresh","caution","expired"];
  const stageMix = payload.mixing || {
    fresh: { theme: 70, accent: 30 },
    caution: { theme: 50, accent: 50 },
    expired: { theme: 30, accent: 70 }
  };
  stages.forEach((key) => {
    const stageStyles = payload.styles?.[key];
    if (!stageStyles?.accent) {
      return;
    }
    const mix = stageMix[key];
    const borderTheme = Math.min(mix.theme + 15, 100);
    const borderAccent = Math.max(mix.accent - 15, 0);
    indicator.style.setProperty("--validity-accent-" + key, stageStyles.accent);
    indicator.style.setProperty(
      "--validity-bg-" + key,
      "color-mix(in oklab, var(--primary) " + mix.theme + "%, " + stageStyles.accent + " " + mix.accent + "%)"
    );
    indicator.style.setProperty(
      "--validity-border-" + key,
      "color-mix(in oklab, var(--primary) " + borderTheme + "%, " + stageStyles.accent + " " + borderAccent + "%)"
    );
    indicator.style.setProperty(
      "--validity-text-" + key,
      "color-mix(in oklab, " + stageStyles.accent + " 45%, black)"
    );
    indicator.style.setProperty(
      "--validity-muted-" + key,
      "color-mix(in oklab, " + stageStyles.accent + " 30%, black)"
    );
    indicator.style.setProperty(
      "--validity-icon-" + key,
      "color-mix(in oklab, " + stageStyles.accent + " 80%, white)"
    );
  });
})();`}
              </script>
            </>
          )
        }
        {
          !entry.data.image && (
            <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mb-5" />
          )
        }
      </div>

      <!-- always show cover as long as it has one -->

      {
        entry.data.image && (
          <ImageWrapper
            id="post-cover"
            src={entry.data.image}
            basePath={path.join("content/posts/", getDir(entry.id))}
            class="mb-8 rounded-xl banner-container onload-animation"
          />
        )
      }

      <Markdown class="mb-6 markdown-content onload-animation">
        <Content />
      </Markdown>

      {
        licenseConfig.enable && (
          <License
            title={entry.data.title}
            slug={entry.slug}
            pubDate={entry.data.published}
            class="mb-6 rounded-xl license-container onload-animation"
          />
        )
      }

      {
        giscusConfig.enable && (
          <div class="onload-animation mb-6">
            <Giscus
              repo={giscusConfig.repo}
              repoId={giscusConfig.repoId}
              category={giscusConfig.category}
              categoryId={giscusConfig.categoryId}
              mapping={giscusConfig.mapping}
              term={giscusConfig.term}
              strict={giscusConfig.strict}
              reactionsEnabled={giscusConfig.reactionsEnabled}
              emitMetadata={giscusConfig.emitMetadata}
              inputPosition={giscusConfig.inputPosition}
              themeLight={giscusConfig.themeLight}
              themeDark={giscusConfig.themeDark}
              lang={giscusConfig.lang}
              loading={giscusConfig.loading}
            />
          </div>
        )
      }
    </div>
  </div>

  <div
    class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
  >
    <a
      href={entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.nextSlug },
      ]}
    >
      {
        entry.data.nextSlug && (
          <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
            <Icon
              name="material-symbols:chevron-left-rounded"
              class="text-[2rem] text-[var(--primary)]"
            />
            <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
              {entry.data.nextTitle}
            </div>
          </div>
        )
      }
    </a>

    <a
      href={entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.prevSlug },
      ]}
    >
      {
        entry.data.prevSlug && (
          <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
            <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
              {entry.data.prevTitle}
            </div>
            <Icon
              name="material-symbols:chevron-right-rounded"
              class="text-[2rem] text-[var(--primary)]"
            />
          </div>
        )
      }
    </a>
  </div>
</MainGridLayout>

<style lang="css">
  :global(.content-validity-indicator) {
    display: flex;
    align-items: flex-start;
    gap: 0.8rem;
    padding: 0.65rem 0.95rem;
    border-radius: calc(var(--radius-large) * 0.85);
    border: 1px solid var(--validity-border-fresh, rgba(0, 0, 0, 0.08));
    background: color-mix(
      in oklab,
      var(--validity-bg-fresh, var(--card-bg)) 82%,
      var(--page-bg) 18%
    );
    color: var(
      --validity-text-fresh,
      color-mix(in oklab, var(--primary) 45%, black)
    );
    margin-bottom: 0.9rem;
  }

  :global(.content-validity-indicator[data-stage="fresh"]) {
    background: color-mix(
      in oklab,
      var(--validity-bg-fresh, var(--card-bg)) 88%,
      var(--page-bg) 12%
    );
    border-color: var(
      --validity-border-fresh,
      color-mix(in oklab, var(--primary) 70%, rgba(0, 0, 0, 0.18))
    );
    color: var(
      --validity-text-fresh,
      color-mix(in oklab, var(--primary) 42%, black)
    );
  }

  :global(.content-validity-indicator[data-stage="caution"]) {
    background: color-mix(
      in oklab,
      var(--validity-bg-caution, var(--card-bg)) 85%,
      var(--page-bg) 15%
    );
    border-color: var(
      --validity-border-caution,
      color-mix(in oklab, rgba(255, 140, 0, 1) 65%, black 35%)
    );
    color: var(
      --validity-text-caution,
      color-mix(in oklab, rgba(255, 140, 0, 1) 50%, black)
    );
  }

  :global(.content-validity-indicator[data-stage="expired"]) {
    background: color-mix(
      in oklab,
      var(--validity-bg-expired, var(--card-bg)) 83%,
      var(--page-bg) 17%
    );
    border-color: var(
      --validity-border-expired,
      color-mix(in oklab, rgba(220, 20, 60, 1) 65%, black 35%)
    );
    color: var(
      --validity-text-expired,
      color-mix(in oklab, rgba(220, 20, 60, 1) 55%, black)
    );
  }

  :global(.content-validity-indicator__icon) {
    width: 2.65rem;
    height: 2.65rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(
      in oklab,
      var(--validity-icon-fresh, var(--primary)) 45%,
      var(--page-bg) 55%
    );
    border: 1px solid currentColor;
    color: var(--validity-icon-fresh, var(--primary));
    flex-shrink: 0;
  }

  :global(
      .content-validity-indicator[data-stage="caution"]
        .content-validity-indicator__icon
    ) {
    color: var(--validity-icon-caution, rgba(255, 140, 0, 1));
    background: color-mix(
      in oklab,
      var(--validity-icon-caution, rgba(255, 140, 0, 1)) 40%,
      var(--page-bg) 60%
    );
  }

  :global(
      .content-validity-indicator[data-stage="expired"]
        .content-validity-indicator__icon
    ) {
    color: var(--validity-icon-expired, rgba(220, 20, 60, 1));
    background: color-mix(
      in oklab,
      var(--validity-icon-expired, rgba(220, 20, 60, 1)) 40%,
      var(--page-bg) 60%
    );
  }

  :global(.content-validity-indicator__icon-symbol) {
    font-size: 1.4rem;
  }

  :global(.content-validity-indicator__body) {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  :global(.content-validity-indicator__label) {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0;
  }

  :global(.content-validity-indicator__description) {
    margin: 0;
    font-size: 0.82rem;
    color: var(--validity-muted-fresh, inherit);
    opacity: 0.85;
  }

  :global(
      .content-validity-indicator[data-stage="caution"]
        .content-validity-indicator__description
    ) {
    color: var(--validity-muted-caution, inherit);
  }

  :global(
      .content-validity-indicator[data-stage="expired"]
        .content-validity-indicator__description
    ) {
    color: var(--validity-muted-expired, inherit);
  }
</style>
