---
import { Icon } from "astro-icon/components";
import { type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";
import Categories from "./Categories.astro";
import Profile from "./Profile.astro";
import Tags from "./Tags.astro";

interface Props {
  links: NavBarLink[];
}

const links = Astro.props.links;
---

<div
  id="nav-menu-overlay"
  aria-hidden="true"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm md:hidden"
>
</div>

<div
  id="nav-menu-panel"
  aria-hidden="true"
  class="fixed top-0 left-0 h-full bg-[var(--card-bg)] shadow-2xl border-l border-[var(--line-divider)] overflow-y-auto overflow-x-hidden md:hidden"
>
  <div class="flex flex-col h-full">
    <div id="nav-menu-content" class="flex-1 overflow-y-auto p-4">
      <div class="lg:hidden flex flex-col gap-4">
        <Profile />
        <div class="border-t border-[var(--line-divider)] mb-4"></div>
        <div class="flex flex-col gap-2 mb-6">
          {
            links.map((link) => (
              <a
                href={link.external ? link.url : url(link.url)}
                class="nav-link group flex justify-between items-center py-3 ps-5 pe-4 rounded-xl gap-4 transition-all"
                target={link.external ? "_blank" : null}
              >
                <div class="transition text-black/75 dark:text-white/75 font-medium group-hover:text-[var(--primary)] group-active:text-[var(--primary)]">
                  {link.name}
                </div>
                <div class="flex items-center gap-2">
                  {!link.external && (
                    <Icon
                      name="material-symbols:chevron-right-rounded"
                      class="transition text-[1.25rem] text-[var(--primary)] group-hover:translate-x-1"
                    />
                  )}
                  {link.external && (
                    <Icon
                      name="fa6-solid:arrow-up-right-from-square"
                      class="transition text-[0.75rem] text-black/25 dark:text-white/25"
                    />
                  )}
                </div>
              </a>
            ))
          }
        </div>
        <Categories />
        <Tags />
      </div>
    </div>
  </div>
</div>

<div
  id="nav-menu-popover"
  aria-hidden="true"
  class="hidden md:block lg:hidden fixed top-[5.25rem] right-4 w-[22rem] max-w-[calc(100vw_-_2rem)] rounded-2xl border border-[var(--line-divider)] bg-[var(--card-bg)] shadow-2xl overflow-y-auto"
>
  <div class="p-4 flex flex-col gap-4">
    <Profile />
    <Categories />
    <Tags />
  </div>
</div>

<script>
  type NavMenuAction = "open" | "close";
  type ViewportMode = "mobile" | "medium" | "desktop";
  type Surface = "sidebar" | "popover";

  declare global {
    interface Window {
      openNavMenu?: () => void;
      closeNavMenu?: () => void;
      __navMenuPending?: NavMenuAction | null;
    }
  }

  window.__navMenuPending ??= null;

  function setupNavMenu() {
    const overlayEl = document.getElementById(
      "nav-menu-overlay"
    ) as HTMLElement | null;
    const panelEl = document.getElementById(
      "nav-menu-panel"
    ) as HTMLElement | null;
    const popoverEl = document.getElementById(
      "nav-menu-popover"
    ) as HTMLElement | null;
    const triggerEl = document.getElementById(
      "nav-menu-switch"
    ) as HTMLElement | null;
    if (!overlayEl || !panelEl || !popoverEl) return;

    const BREAKPOINT_MD = 768;
    const BREAKPOINT_LG = 1024;

    const getViewportMode = (): ViewportMode => {
      const width = window.innerWidth;
      if (width < BREAKPOINT_MD) return "mobile";
      if (width < BREAKPOINT_LG) return "medium";
      return "desktop";
    };

    let mode: ViewportMode = getViewportMode();
    let activeSurface: Surface | null = null;

    const setTriggerState = () => {
      triggerEl?.setAttribute("aria-expanded", (!!activeSurface).toString());
    };

    const setVisibility = (element: HTMLElement, visible: boolean) => {
      element.classList.toggle("is-visible", visible);
      element.setAttribute("aria-hidden", visible ? "false" : "true");
    };

    const openSurface = (target: Surface) => {
      if (activeSurface === target) return;
      if (target === "sidebar") {
        setVisibility(popoverEl, false);
        setVisibility(overlayEl, true);
        setVisibility(panelEl, true);
        document.body.style.overflow = "hidden";
      } else {
        setVisibility(overlayEl, false);
        setVisibility(panelEl, false);
        setVisibility(popoverEl, true);
        document.body.style.overflow = "";
      }
      activeSurface = target;
      setTriggerState();
    };

    const closeSurface = (target: Surface) => {
      if (target === "sidebar") {
        setVisibility(overlayEl, false);
        setVisibility(panelEl, false);
        document.body.style.overflow = "";
      } else {
        setVisibility(popoverEl, false);
      }
      if (activeSurface === target) {
        activeSurface = null;
        setTriggerState();
      }
    };

    const closeAll = () => {
      closeSurface("sidebar");
      closeSurface("popover");
    };

    const runAction = (action: NavMenuAction) => {
      if (action === "open") {
        if (mode === "mobile") {
          openSurface("sidebar");
        } else if (mode === "medium") {
          openSurface("popover");
        }
        return;
      }
      closeAll();
    };

    window.openNavMenu = () => runAction("open");
    window.closeNavMenu = () => runAction("close");

    if (window.__navMenuPending) {
      const pending = window.__navMenuPending;
      window.__navMenuPending = null;
      runAction(pending);
    }

    overlayEl.addEventListener("click", (event: MouseEvent) => {
      if (event.target === overlayEl) closeSurface("sidebar");
    });

    document.addEventListener("keydown", (event: KeyboardEvent) => {
      if (event.key === "Escape") closeAll();
    });

    panelEl
      .querySelectorAll<HTMLAnchorElement>("a[href]")
      .forEach((link) =>
        link.addEventListener("click", () =>
          setTimeout(() => closeSurface("sidebar"), 150)
        )
      );

    popoverEl
      .querySelectorAll<HTMLAnchorElement>("a[href]")
      .forEach((link) =>
        link.addEventListener("click", () =>
          setTimeout(() => closeSurface("popover"), 150)
        )
      );

    document.addEventListener("click", (event) => {
      if (mode !== "medium" || activeSurface !== "popover") return;
      const target = event.target as Node;
      if (popoverEl.contains(target)) return;
      if (triggerEl && triggerEl.contains(target)) return;
      closeSurface("popover");
    });

    window.addEventListener(
      "scroll",
      () => {
        if (mode === "medium" && activeSurface === "popover") {
          closeSurface("popover");
        }
      },
      { passive: true }
    );

    const handleViewportChange = () => {
      const nextMode = getViewportMode();
      if (nextMode === mode) return;
      mode = nextMode;
      if (mode === "mobile") {
        closeSurface("popover");
      } else if (mode === "medium") {
        closeSurface("sidebar");
      } else {
        closeAll();
      }
    };

    window.addEventListener("resize", handleViewportChange);

    closeAll();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupNavMenu);
  } else {
    setupNavMenu();
  }
</script>

<style>
  #nav-menu-overlay {
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition:
      opacity 0.45s cubic-bezier(0.33, 1, 0.68, 1),
      visibility 0s linear 0.45s;
  }
  #nav-menu-overlay.is-visible {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 0.45s cubic-bezier(0.33, 1, 0.68, 1);
  }
  #nav-menu-panel {
    z-index: 9999;
    width: 280px;
    transform: translateX(-100%);
    transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    scrollbar-width: none;
    -ms-overflow-style: none;
    box-shadow:
      -10px 0 25px -5px rgba(0, 0, 0, 0.1),
      -10px 0 10px -5px rgba(0, 0, 0, 0.04);
  }
  .dark #nav-menu-panel {
    box-shadow:
      -10px 0 25px -5px rgba(0, 0, 0, 0.3),
      -10px 0 10px -5px rgba(0, 0, 0, 0.2);
  }
  #nav-menu-panel.is-visible {
    transform: translateX(0);
  }
  #nav-menu-panel .nav-link {
    position: relative;
    overflow: hidden;
  }
  #nav-menu-panel .nav-link::before {
    content: "";
    position: absolute;
    left: 0;
    top: 10%;
    bottom: 10%;
    width: 6px;
    background: var(--primary);
    border-radius: 999px;
    transform: translate(-150%, 0);
    transition: transform 0.25s ease;
  }
  #nav-menu-panel .nav-link:hover::before,
  #nav-menu-panel .nav-link:focus-visible::before,
  #nav-menu-panel .nav-link:active::before {
    transform: translate(0, 0);
  }
  #nav-menu-content::-webkit-scrollbar {
    display: none;
  }
  #nav-menu-popover {
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transform: translate3d(0, -12px, 0) scale(0.98);
    transition:
      opacity 0.25s ease,
      visibility 0s linear 0.25s,
      transform 0.25s ease;
    max-height: calc(100vh - 6rem);
  }
  #nav-menu-popover.is-visible {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translate3d(0, 0, 0) scale(1);
    transition:
      opacity 0.25s ease,
      transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
  }
  @media (max-width: 640px) {
    #nav-menu-panel {
      width: 280px;
      max-width: 90vw;
    }
  }
</style>
